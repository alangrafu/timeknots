var TimeKnots={draw:function(a,b,c){function i(a,b){var c=b?1.5:1,e=b?d.colorTimeline:d.backgroundCircle;return a.style("fill",function(a){return void 0!=a.color?a.color:e}).transition().duration(100).attr("r",function(a){return void 0!=a.radius?Math.floor(d.radius*c):Math.floor(d.radius*c)})}function j(a,b){var c=b?.9:0;return a.transition().duration(100).style("opacity",c)}function k(){var b=d3.selectAll(a.concat(" circle.timeline-event"));i(b,!1)}function l(a){return d.dateDimension?new Date(a.date).getTime():a.value}var d={width:600,height:200,radius:10,lineWidth:4,colorTimeline:"#999",colorTip:"white",backgroundCircle:"#FFF",backgroundTip:"rgba(0,0,0,0.5)",dateFormat:"%Y/%m/%d %H:%M:%S",horizontalLayout:!0,showLabels:!1,labelFormat:"%Y/%m/%d %H:%M:%S",addNow:!1,seriesColor:d3.scale.category20(),dateDimension:!0,tipPosition:"float"};if(void 0!=c)for(var e in c)d[e]=c[e];0!=d.addNow&&b.push({date:new Date,name:d.addNowLabel||"Today"});var f="top"==d.tipPosition&&1==d.horizontalLayout,g=null;f?(d.height=d.height/2,g=d3.select(a).append("div").style("min-height",d.height)):g=d3.select(a).append("div").style("position","absolute"),g.style("opacity",0).style("font-family","Helvetica Neue").style("font-weight","300").style("background",d.backgroundTip).style("color",d.colorTip).style("padding","5px 10px 5px 10px").style("-moz-border-radius","8px 8px").style("border-radius","8px 8px");var h=d3.select(a).append("svg").attr("width",d.width).attr("height",d.height),m=d.dateDimension?b.map(function(a){return Date.parse(a.date)}):b.map(function(a){return a.value}),n=d3.max(m),o=d3.min(m),p=1.5*(d3.max(b.map(function(a){return a.radius}))||d.radius)+d.lineWidth,q=d.horizontalLayout?(d.width-2*p)/(n-o):(d.height-2*p)/(n-o),r=[];if(n==o&&(q=0,p=d.horizontalLayout?d.width/2:d.height/2),linePrevious={x1:null,x2:null,y1:null,y2:null},h.selectAll("line").data(b).enter().append("line").attr("class","timeline-line").attr("x1",function(a){var b=d.horizontalLayout?Math.floor(q*(l(a)-o)+p):Math.floor(d.width/2);return linePrevious.x1=b,b}).attr("x2",function(a){return null!=linePrevious.x1?linePrevious.x1:Math.floor(d.width/2)}).attr("y1",function(a){var b=d.horizontalLayout?Math.floor(d.height/2):Math.floor(q*(l(a)-o))+p;return linePrevious.y1=b,b}).attr("y2",function(a){return null!=linePrevious.y1?linePrevious.y1:d.horizontalLayout?Math.floor(d.height/2):Math.floor(q*(l(a)-o))}).style("stroke",function(a){return void 0!=a.color?a.color:void 0!=a.series?(r.indexOf(a.series)<0&&r.push(a.series),d.seriesColor(r.indexOf(a.series))):d.colorTimeline}).style("stroke-width",d.lineWidth),h.selectAll("circle").data(b).enter().append("circle").attr("class","timeline-event").attr("r",function(a){return void 0!=a.radius?a.radius:d.radius}).style("stroke",function(a){return void 0!=a.color?a.color:void 0!=a.series?(r.indexOf(a.series)<0&&r.push(a.series),console.log(a.series,r,r.indexOf(a.series)),d.seriesColor(r.indexOf(a.series))):d.colorTimeline}).style("stroke-width",function(a){return void 0!=a.lineWidth?a.lineWidth:d.lineWidth}).style("fill",function(a){return void 0!=a.background?a.background:d.backgroundCircle}).attr("cy",function(a){return d.horizontalLayout?Math.floor(d.height/2):Math.floor(q*(l(a)-o)+p)}).attr("cx",function(a){if(d.horizontalLayout){var b=Math.floor(q*(l(a)-o)+p);return b}return Math.floor(d.width/2)}).on("mouseover",function(a){if(d.dateDimension)var b=d3.time.format(d.dateFormat),c=b(new Date(a.date));else var b=function(a){return a},c=a.value;a.name;g.html(""),void 0!=a.img&&g.append("img").style("float","left").style("margin-right","4px").attr("src",a.img).attr("width","64px"),g.append("strong").text(a.name).style("font-weight","bold"),""!=c&&g.append("date").text(c).style("display","inline-block").style("margin-left","10px"),void 0!=a.description&&g.append("span").html(a.description).style("display","block"),f?k():g.append("div").style("float","left"),i(d3.select(this),!0),j(g,!0),void 0!=d.onMouseOver&&d.onMouseOver(d3.select(this),g)}).on("mouseout",function(){1!=f&&(j(g,!1),i(d3.select(this),!1)),void 0!=d.onMouseOut&&d.onMouseOut(d3.select(this),g)}),0!=d.showLabels){if(d.dateDimension)var s=d3.time.format(d.labelFormat),t=s(new Date(o)),u=s(new Date(n));else var s=function(a){return a},t=o,u=n;h.append("text").text(t).style("font-size","70%").attr("x",function(a){return d.horizontalLayout?d3.max([0,p-this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(a){return d.horizontalLayout?Math.floor(d.height/2+(p+this.getBBox().height)):p+this.getBBox().height/2}),h.append("text").text(u).style("font-size","70%").attr("x",function(a){return d.horizontalLayout?d.width-d3.max([this.getBBox().width,p+this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(a){return d.horizontalLayout?Math.floor(d.height/2+(p+this.getBBox().height)):d.height-p+this.getBBox().height/2})}h.on("mousemove",function(){return tipPixels=parseInt(g.style("height").replace("px","")),g.style("top",d3.event.pageY-tipPixels-p+"px").style("left",d3.event.pageX+20+"px")}).on("mouseout",function(){return 1==f?g:j(g,!1).style("top","0px").style("left","0px")})}};