var TimeKnots={draw:function(a,b,c){function i(a,b){var c=b?1.5:1,e=b?d.color:d.background;return a.style("fill",function(a){return void 0!=a.color?a.color:e}).transition().duration(100).attr("r",function(a){return void 0!=a.radius?Math.floor(d.radius*c):Math.floor(d.radius*c)})}function j(a,b){var c=b?.9:0;return a.transition().duration(100).style("opacity",c)}function k(){var b=d3.selectAll(a.concat(" circle.timeline-event"));i(b,!1)}var d={width:600,height:200,radius:10,lineWidth:4,color:"#999",background:"#FFF",dateFormat:"%Y/%m/%d %H:%M:%S",horizontalLayout:!0,showLabels:!1,labelFormat:"%Y/%m/%d %H:%M:%S",addNow:!1,seriesColor:d3.scale.category20(),dateDimension:!0,tipPosition:"float"};if(void 0!=c)for(var e in c)d[e]=c[e];0!=d.addNow&&b.push({date:new Date,name:d.addNowLabel||"Today"});var f="top"==d.tipPosition&&1==d.horizontalLayout,g=null;f?(d.height=d.height/2,g=d3.select(a).append("div").style("min-height",d.height)):g=d3.select(a).append("div").style("position","absolute"),g.style("opacity",0).style("font-family","Helvetica Neue").style("font-weight","300").style("background","rgba(0,0,0,0.5)").style("color","white").style("padding","5px 10px 5px 10px").style("-moz-border-radius","8px 8px").style("border-radius","8px 8px");var h=d3.select(a).append("svg").attr("width",d.width).attr("height",d.height);if(d.dateDimension)var l=b.map(function(a){return Date.parse(a.date)}),m=d3.max(l),n=d3.min(l);else var l=b.map(function(a){return a.value}),m=d3.max(l),n=d3.min(l);var o=1.5*(d3.max(b.map(function(a){return a.radius}))||d.radius)+d.lineWidth,p=d.horizontalLayout?(d.width-2*o)/(m-n):(d.height-2*o)/(m-n),q=[];if(m==n&&(p=0,o=d.horizontalLayout?d.width/2:d.height/2),linePrevious={x1:null,x2:null,y1:null,y2:null},h.selectAll("line").data(b).enter().append("line").attr("class","timeline-line").attr("x1",function(a){var b;if(d.horizontalLayout){var c=d.dateDimension?new Date(a.date).getTime():a.value;b=Math.floor(p*(c-n)+o)}else b=Math.floor(d.width/2);return linePrevious.x1=b,b}).attr("x2",function(a){if(null!=linePrevious.x1)return linePrevious.x1;if(d.horizontalLayout){var b=d.dateDimension?new Date(a.date).getTime():a.value;ret=Math.floor(p*(b-n))}return Math.floor(d.width/2)}).attr("y1",function(a){var b;if(d.horizontalLayout)b=Math.floor(d.height/2);else{var c=d.dateDimension?new Date(a.date).getTime():a.value;b=Math.floor(p*(c-n))+o}return linePrevious.y1=b,b}).attr("y2",function(a){if(null!=linePrevious.y1)return linePrevious.y1;if(d.horizontalLayout)return Math.floor(d.height/2);var b=d.dateDimension?new Date(a.date).getTime():a.value;return Math.floor(p*(b-n))}).style("stroke",function(a){return void 0!=a.color?a.color:void 0!=a.series?(q.indexOf(a.series)<0&&q.push(a.series),d.seriesColor(q.indexOf(a.series))):d.color}).style("stroke-width",d.lineWidth),h.selectAll("circle").data(b).enter().append("circle").attr("class","timeline-event").attr("r",function(a){return void 0!=a.radius?a.radius:d.radius}).style("stroke",function(a){return void 0!=a.color?a.color:void 0!=a.series?(q.indexOf(a.series)<0&&q.push(a.series),console.log(a.series,q,q.indexOf(a.series)),d.seriesColor(q.indexOf(a.series))):d.color}).style("stroke-width",function(a){return void 0!=a.lineWidth?a.lineWidth:d.lineWidth}).style("fill",function(a){return void 0!=a.background?a.background:d.background}).attr("cy",function(a){if(d.horizontalLayout)return Math.floor(d.height/2);var b=d.dateDimension?new Date(a.date).getTime():a.value;return Math.floor(p*(b-n)+o)}).attr("cx",function(a){if(d.horizontalLayout){var b=d.dateDimension?new Date(a.date).getTime():a.value,c=Math.floor(p*(b-n)+o);return c}return Math.floor(d.width/2)}).on("mouseover",function(a){if(d.dateDimension)var b=d3.time.format(d.dateFormat),c=b(new Date(a.date)),e=""!=c?a.name+" <small>("+c+")</small>":a.name;else var b=function(a){return a},c=a.value,e=a.name+" <small>("+a.value+")</small>";g.html(e),void 0!=a.img&&g.append("img").style("float","left").style("margin-right","4px").attr("src",a.img).attr("width","64px"),f?k():g.append("div").style("float","left"),i(d3.select(this),!0),j(g,!0),void 0!=d.onMouseOver&&d.onMouseOver(d3.select(this),g)}).on("mouseout",function(){1!=f&&(j(g,!1),i(d3.select(this),!1)),void 0!=d.onMouseOut&&d.onMouseOut(d3.select(this),g)}),0!=d.showLabels){if(d.dateDimension)var r=d3.time.format(d.labelFormat),s=r(new Date(n)),t=r(new Date(m));else var r=function(a){return a},s=n,t=m;h.append("text").text(s).style("font-size","70%").attr("x",function(a){return d.horizontalLayout?d3.max([0,o-this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(a){return d.horizontalLayout?Math.floor(d.height/2+(o+this.getBBox().height)):o+this.getBBox().height/2}),h.append("text").text(t).style("font-size","70%").attr("x",function(a){return d.horizontalLayout?d.width-d3.max([this.getBBox().width,o+this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(a){return d.horizontalLayout?Math.floor(d.height/2+(o+this.getBBox().height)):d.height-o+this.getBBox().height/2})}h.on("mousemove",function(){return tipPixels=parseInt(g.style("height").replace("px","")),g.style("top",d3.event.pageY-tipPixels-o+"px").style("left",d3.event.pageX+20+"px")}).on("mouseout",function(){return 1==f?g:j(g,!1).style("top","0px").style("left","0px")})}};