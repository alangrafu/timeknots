var TimeKnots={draw:function(t,e,i){function o(t,e){var i=e?1.5:1,o=e?l.colorTimeline:l.backgroundCircle;return t.style("fill",function(t){return void 0!=t.color?t.color:o}).transition().duration(100).attr("r",function(t){return void 0!=t.radius?Math.floor(l.radius*i):Math.floor(l.radius*i)})}function n(t,e){var i=e?.9:0;return t.transition().duration(100).style("opacity",i)}function r(){var e=d3.selectAll(t.concat(" circle.timeline-event"));o(e,!1)}function a(t){return l.dateDimension?new Date(t.date).getTime():t.value}var l={width:600,height:200,radius:10,lineWidth:4,colorTimeline:"#999",colorTip:"white",backgroundCircle:"#FFF",backgroundTip:"rgba(0,0,0,0.5)",dateFormat:"%Y/%m/%d %H:%M:%S",horizontalLayout:!0,showLabels:!1,labelFormat:"%Y/%m/%d %H:%M:%S",addNow:!1,seriesColor:d3.scale.category20(),dateDimension:!0,tipPosition:"float"};if(void 0!=i)for(var s in i)l[s]=i[s];0!=l.addNow&&e.push({date:new Date,name:l.addNowLabel||"Today"});var d="top"==l.tipPosition&&1==l.horizontalLayout,u=null;d?(l.height=l.height/2,u=d3.select(t).append("div").style("min-height",l.height)):u=d3.select(t).append("div").style("position","absolute"),u.style("opacity",0).style("font-family","Helvetica Neue").style("font-weight","300").style("background",l.backgroundTip).style("color",l.colorTip).style("padding","5px 10px 5px 10px").style("-moz-border-radius","8px 8px").style("border-radius","8px 8px");var h=d3.select(t).append("svg").attr("width",l.width).attr("height",l.height),c=l.dateDimension?e.map(function(t){return Date.parse(t.date)}):e.map(function(t){return t.value}),f=d3.max(c),p=d3.min(c),y=1.5*(d3.max(e.map(function(t){return t.radius}))||l.radius)+l.lineWidth,g=l.horizontalLayout?(l.width-2*y)/(f-p):(l.height-2*y)/(f-p),x=[];if(f==p&&(g=0,y=l.horizontalLayout?l.width/2:l.height/2),linePrevious={x1:null,x2:null,y1:null,y2:null},h.selectAll("line").data(e).enter().append("line").attr("class","timeline-line").attr("x1",function(t){var e=l.horizontalLayout?Math.floor(g*(a(t)-p)+y):Math.floor(l.width/2);return linePrevious.x1=e,e}).attr("x2",function(t){return null!=linePrevious.x1?linePrevious.x1:Math.floor(l.width/2)}).attr("y1",function(t){var e=l.horizontalLayout?Math.floor(l.height/2):Math.floor(g*(a(t)-p))+y;return linePrevious.y1=e,e}).attr("y2",function(t){return null!=linePrevious.y1?linePrevious.y1:l.horizontalLayout?Math.floor(l.height/2):Math.floor(g*(a(t)-p))}).style("stroke",function(t){return void 0!=t.color?t.color:void 0!=t.series?(x.indexOf(t.series)<0&&x.push(t.series),l.seriesColor(x.indexOf(t.series))):l.colorTimeline}).style("stroke-width",l.lineWidth),h.selectAll("circle").data(e).enter().append("circle").attr("class","timeline-event").attr("r",function(t){return void 0!=t.radius?t.radius:l.radius}).style("stroke",function(t){return void 0!=t.color?t.color:void 0!=t.series?(x.indexOf(t.series)<0&&x.push(t.series),console.log(t.series,x,x.indexOf(t.series)),l.seriesColor(x.indexOf(t.series))):l.colorTimeline}).style("stroke-width",function(t){return void 0!=t.lineWidth?t.lineWidth:l.lineWidth}).style("fill",function(t){return void 0!=t.background?t.background:l.backgroundCircle}).attr("cy",function(t){return l.horizontalLayout?Math.floor(l.height/2):Math.floor(g*(a(t)-p)+y)}).attr("cx",function(t){if(l.horizontalLayout){var e=Math.floor(g*(a(t)-p)+y);return e}return Math.floor(l.width/2)}).on("mouseover",function(t){if(l.dateDimension)var e=d3.time.format(l.dateFormat),i=e(new Date(t.date));else var e=function(t){return t},i=t.value;t.name;u.html(""),void 0!=t.img&&u.append("img").style("float","left").style("margin-right","4px").attr("src",t.img).attr("width","64px"),u.append("strong").text(t.name).style("font-weight","bold"),""!=i&&u.append("date").text(i).style("display","inline-block").style("margin-left","10px"),void 0!=t.description&&u.append("span").text(t.description).style("display","block"),d?r():u.append("div").style("float","left"),o(d3.select(this),!0),n(u,!0),void 0!=l.onMouseOver&&l.onMouseOver(d3.select(this),u)}).on("mouseout",function(){1!=d&&(n(u,!1),o(d3.select(this),!1)),void 0!=l.onMouseOut&&l.onMouseOut(d3.select(this),u)}),0!=l.showLabels){if(l.dateDimension)var v=d3.time.format(l.labelFormat),m=v(new Date(p)),w=v(new Date(f));else var v=function(t){return t},m=p,w=f;h.append("text").text(m).style("font-size","70%").attr("x",function(t){return l.horizontalLayout?d3.max([0,y-this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(t){return l.horizontalLayout?Math.floor(l.height/2+(y+this.getBBox().height)):y+this.getBBox().height/2}),h.append("text").text(w).style("font-size","70%").attr("x",function(t){return l.horizontalLayout?l.width-d3.max([this.getBBox().width,y+this.getBBox().width/2]):Math.floor(this.getBBox().width/2)}).attr("y",function(t){return l.horizontalLayout?Math.floor(l.height/2+(y+this.getBBox().height)):l.height-y+this.getBBox().height/2})}h.on("mousemove",function(){return tipPixels=parseInt(u.style("height").replace("px","")),u.style("top",d3.event.pageY-tipPixels-y+"px").style("left",d3.event.pageX+20+"px")}).on("mouseout",function(){return 1==d?u:n(u,!1).style("top","0px").style("left","0px")})}};